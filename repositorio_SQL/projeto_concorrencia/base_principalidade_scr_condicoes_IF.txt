--CONDIÇÕES DAS IF's CONCORRENTES OBTIDAS VIA SCR

WITH 

base_principalidade AS (
  SELECT SUBSTR(document,1,8) AS RootDocumentNumber,*
  FROM `dataplatform-nonprd.credit_negocios.concorrencia_base_if`
  WHERE 1=1 
  AND soma_trimestral > 0
  AND month_year >= "2025-01-01"
),

base_principalidade_scr AS (
  SELECT b.*,
  a.desembolso_scr,
  a.prazo_scr,
  a.taxa_scr,
  CASE WHEN desembolso_scr > 0 AND desembolso_scr <= 500000 THEN "Automatica"
       WHEN desembolso_scr > 500000 AND desembolso_scr <= 50000000 THEN "Especializada" END AS esteira
  FROM (
    SELECT DISTINCT 
      RootDocumentNumber AS rdn,
      ReferenceDate,
      TaxaImplicita as taxa_scr,
      Prazo_Operacao as prazo_scr,
      Credito AS desembolso_scr
    FROM `dataplatform-prd.credit_negocios.dsh_tbl_SCR_Variation_KGiro_Treated`
    WHERE ReferenceDate >= "2025-01-01"
  ) AS a
  INNER JOIN base_principalidade AS b
  ON a.rdn = b.RootDocumentNumber
  AND a.ReferenceDate = b.month_year
),

base_principalidade_scr_aggIF AS (
  SELECT 
  IF_adj,
  esteira,
  COUNT(*) AS n_operacoes_scr,
  SUM(desembolso_scr) AS desembolso_total_scr,
  AVG(desembolso_scr) AS desembolso_medio_scr,
  AVG(taxa_scr) AS taxa_media_scr,
  AVG(prazo_scr) AS prazo_medio_scr,
  FROM base_principalidade_scr
  WHERE esteira IS NOT NULL
  GROUP BY IF_adj, esteira
),

nome_bancos AS(
  SELECT DISTINCT IF_adj 
  FROM base_principalidade   
),

nome_esteira AS(
  SELECT DISTINCT esteira 
  FROM base_principalidade_scr_aggIF   
),

cross_esteira_bancos AS(
  SELECT *
  FROM nome_bancos AS a
  CROSS JOIN nome_esteira as b
  WHERE esteira IS NOT NULL
)

SELECT 
a.*,
b.n_operacoes_scr,
b.desembolso_total_scr,
b.desembolso_medio_scr,
b.prazo_medio_scr,
b.taxa_media_scr 
FROM cross_esteira_bancos AS a
LEFT JOIN base_principalidade_scr_aggIF AS b
ON a.IF_adj = b.IF_adj
AND a.esteira = b.esteira
ORDER BY IF_adj, esteira

--------------------------------------------------------------------------------------------

--CONDIÇÕES DA STONE OBTIDAS VIA BOT

WITH

base_desembolso_stone AS( 
  SELECT 
  maximumTerm AS prazo_stone, 
  InterestRate as taxa_stone, 
  CreditAmount as desembolsado_stone, 
  offerType
  FROM
    (SELECT *
    FROM `dataplatform-prd.credit_business_intelligence.tbl_business_offer_tracker` 
    WHERE 1=1
    AND LoanDisbursementDate IS NOT NULL
    QUALIFY ROW_NUMBER() OVER (PARTITION BY CustomerDocument ORDER BY LoanDisbursementDate ASC) = 1)
  WHERE EXTRACT(YEAR FROM LoanDisbursementDate) = 2025
  AND CustomerDocumentType = "CNPJ"
)

SELECT 
COUNT(*) AS n_operacao,
SUM(desembolsado_stone) AS total_desembolsado_stone,
AVG(desembolsado_stone) AS media_desembolsado_stone,
AVG(prazo_stone) AS media_prazo_stone,
AVG(taxa_stone) AS media_taxa_stone,
FROM base_desembolso_stone
GROUP BY offerType














