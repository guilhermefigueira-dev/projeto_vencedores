--CONDIÇÕES DAS IF's CONCORRENTES OBTIDAS VIA SCR

WITH 

base_principalidade AS (
  SELECT SUBSTR(document,1,8) AS RootDocumentNumber,*
  FROM `dataplatform-nonprd.credit_negocios.concorrencia_base_if`
  WHERE 1=1 
  AND soma_trimestral > 0
  AND month_year >= "2025-01-01"
),

base_rating as (
  select 
  RootDocumentNumber, 
  ReferenceDate, 
  CreditRating 
  from `dataplatform-prd.credit_data_tribe.application_output` 
  where 1=1
  and extract(year from ReferenceDate) = 2025
),

base_rating_last as(
  select *
  from base_rating
  qualify row_number() over(
    partition by RootDocumentNumber, extract(month from ReferenceDate)
    order by ReferenceDate DESC
  ) = 1
),

base_rating_last_if as (
  select 
    a.RootDocumentNumber,
    a.month_year,
    -- Extrai o número antes dos dois pontos e converte para numérico
    SAFE_CAST(REGEXP_EXTRACT(b.CreditRating, r'^([0-9.]+):') AS FLOAT64) AS CreditRating_num
  from base_principalidade a
  inner join base_rating_last b
    on a.RootDocumentNumber = b.RootDocumentNumber
    and a.month_year = DATE_TRUNC(b.ReferenceDate, MONTH)
),

base_principalidade_scr AS (
  SELECT b.*,
  a.desembolso_scr,
  a.prazo_scr,
  a.taxa_scr,
  CASE WHEN desembolso_scr > 0 AND desembolso_scr <= 500000 THEN "Automatica"
       WHEN desembolso_scr > 500000 AND desembolso_scr <= 50000000 THEN "Especializada" END AS esteira
  FROM (
    SELECT DISTINCT 
      RootDocumentNumber AS rdn,
      ReferenceDate,
      TaxaImplicita as taxa_scr,
      Prazo_Operacao as prazo_scr,
      Credito AS desembolso_scr
    FROM `dataplatform-prd.credit_negocios.dsh_tbl_SCR_Variation_KGiro_Treated`
    WHERE ReferenceDate >= "2025-01-01"
  ) AS a
  INNER JOIN base_principalidade AS b
  ON a.rdn = b.RootDocumentNumber
  AND a.ReferenceDate = b.month_year
),

base_principalidade_scr_rating as(
  select 
  *
  from base_principalidade_scr a
  left join base_rating_last_if b
  using(RootDocumentNumber,month_year)
),

base_principalidade_scr_aggIF AS (
  SELECT DISTINCT
    IF_adj,
    esteira,
    COUNT(*) OVER(PARTITION BY IF_adj, esteira) AS n_operacoes_scr,
    COUNTIF(taxa_scr is not null) OVER(PARTITION BY IF_adj, esteira) as contagem_taxascr_notnull,
    COUNTIF(prazo_scr is not null) OVER(PARTITION BY IF_adj, esteira) as contagem_prazoscr_notnull,
    SUM(desembolso_scr) OVER(PARTITION BY IF_adj, esteira) AS desembolso_total_scr,
    AVG(desembolso_scr) OVER(PARTITION BY IF_adj, esteira) AS desembolso_medio_scr,
    AVG(CreditRating_num) OVER(PARTITION BY IF_adj, esteira) AS rating_medio,
    -- Mediana exata
    PERCENTILE_CONT(desembolso_scr, 0.5) OVER(PARTITION BY IF_adj, esteira) AS desembolso_mediana_scr,
    AVG(taxa_scr) OVER(PARTITION BY IF_adj, esteira) AS taxa_media_scr,
    PERCENTILE_CONT(taxa_scr, 0.5) OVER(PARTITION BY IF_adj, esteira) AS taxa_mediana_scr,
    AVG(prazo_scr) OVER(PARTITION BY IF_adj, esteira) AS prazo_medio_scr,
    PERCENTILE_CONT(prazo_scr, 0.5) OVER(PARTITION BY IF_adj, esteira) AS prazo_mediana_scr
  FROM base_principalidade_scr_rating
  WHERE esteira IS NOT NULL
),

nome_bancos AS(
  SELECT DISTINCT IF_adj 
  FROM base_principalidade   
),

nome_esteira AS(
  SELECT DISTINCT esteira 
  FROM base_principalidade_scr_aggIF   
),

cross_esteira_bancos AS(
  SELECT *
  FROM nome_bancos AS a
  CROSS JOIN nome_esteira as b
  WHERE esteira IS NOT NULL
)

SELECT 
a.*,
b.n_operacoes_scr,
b.rating_medio,
b.desembolso_total_scr,
b.desembolso_medio_scr,
b.prazo_medio_scr,
b.taxa_media_scr,
b.taxa_mediana_scr,
b.contagem_taxascr_notnull,
b.contagem_prazoscr_notnull
FROM cross_esteira_bancos AS a
LEFT JOIN base_principalidade_scr_aggIF AS b
ON a.IF_adj = b.IF_adj
AND a.esteira = b.esteira
ORDER BY IF_adj, esteira

--------------------------------------------------------------------------------------------

--CONDIÇÕES DA STONE OBTIDAS VIA BOT

WITH

base_desembolso_stone AS( 
  SELECT 
  maximumTerm AS prazo_stone, 
  InterestRate as taxa_stone, 
  CreditAmount as desembolsado_stone, 
  offerType
  FROM
    (SELECT *
    FROM `dataplatform-prd.credit_business_intelligence.tbl_business_offer_tracker` 
    WHERE 1=1
    AND LoanDisbursementDate IS NOT NULL
    QUALIFY ROW_NUMBER() OVER (PARTITION BY CustomerDocument ORDER BY LoanDisbursementDate ASC) = 1)
  WHERE EXTRACT(YEAR FROM LoanDisbursementDate) = 2025
  AND CustomerDocumentType = "CNPJ"
)

SELECT 
  offerType,
  COUNT(*) AS n_operacao,
  SUM(desembolsado_stone) AS total_desembolsado_stone,
  
  -- Médias
  AVG(desembolsado_stone) AS media_desembolsado_stone,
  AVG(prazo_stone) AS media_prazo_stone,
  AVG(taxa_stone) AS media_taxa_stone,
  
  -- Medianas
  APPROX_QUANTILES(desembolsado_stone, 2)[OFFSET(1)] AS mediana_desembolsado_stone,
  APPROX_QUANTILES(prazo_stone, 2)[OFFSET(1)] AS mediana_prazo_stone,
  APPROX_QUANTILES(taxa_stone, 2)[OFFSET(1)] AS mediana_taxa_stone

FROM base_desembolso_stone
GROUP BY offerType














