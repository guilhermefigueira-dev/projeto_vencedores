--Código que calcula o quanto que cada stonecode passou de TPV por mês

CREATE OR REPLACE TABLE `dataplatform-nonprd.credit_negocios.concorrencia_stonecode_tpv` AS 

SELECT
  stone_code,
  DATE_TRUNC(reference_date, MONTH) AS reference_month,
  SUM(amount) AS total_amount,
  SUM(transaction_qty) AS qtd_transacoes
FROM `dataplatform-treated-prod.acquirer_core.tpv`
WHERE reference_date IS NOT NULL
GROUP BY
  stone_code,
  reference_month
ORDER BY
  reference_month,
  stone_code;